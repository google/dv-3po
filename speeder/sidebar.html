<script>
  /*
    * Copyright 2021 Google Inc.
    *
    * Licensed under the Apache License, Version 2.0 (the "License");
    * you may not use this file except in compliance with the License.
    * You may obtain a copy of the License at
    *
    *     http://www.apache.org/licenses/LICENSE-2.0
    *
    *     Unless required by applicable law or agreed to in writing, software
    *     distributed under the License is distributed on an "AS IS" BASIS,
    *     WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    *     See the License for the specific language governing permissions and
    *     limitations under the License.
    */

/**
 * Controller functions for the sidebar UI
 */

/**
 * Sets a message to the status field in the sidebar
 */
function setStatus(status) {
  console.log(status);
  document.getElementById('status').innerHTML = status;
}

/**
 * Loads data from DV360 into the sheet
 */
function loadFromDV() {
  setStatus('Loading line items from DV360...');

  // Clear the Log tab
  getLogger().clear().then(function(result) {
    // Create jobs to be executed
    var jobs = [
      {
        'entity': 'InsertionOrder'
      },{
        'entity': 'LineItem'
      }
    ];

    // Run jobs
    return new Runner().run('identifyItemsToLoad', jobs);
  }).then(function(loadJobs) {
    return new Runner().run('generateQAReport', [{jobs: loadJobs}]);
  }).then(function(result) {
    // Log results
    console.log(result);
    return getLogger().log(result)
  }).then(function(result) {
    // Change status back to Ready
    setStatus('The DV360 information has been loaded successfully!');
  });
}

/**
 * Pushes data to DV360
 */
function pushToDV360() {
  if(confirm("Are you sure you want to push the changes to DV360?")) {
    setStatus('Pushing to DV360...');
    // Clear the Log tab
    getLogger().clear().then(function(result) {
      // Create jobs to be executed
      var jobs = [
        {
          'entity': 'LineItem'
        }
      ];
      setStatus('Identifying items to update...');
      // Run jobs
      return new Runner().run('pushToDV360', jobs);
    }).then(function(result) {
      // Log results
      console.log(result);
      return getLogger().log(result)
    }).then(function(result) {
      // Change status
      setStatus('The Brand Safety Controls have been pushed successfully! Please verify them in the UI.');
    });
  }
}

/**
  * Apply Brand Safety Controls to the line items in the QA tab
*/
function applyBrandSafetyControlsConfiguration() {
  setStatus('Applying Brand Safety Controls...');
  google.script.run.withSuccessHandler(successHandler).withFailureHandler(errorHandler).applyBrandSafetyControlsConfiguration();
}

function successHandler(){
  setStatus('The Brand Safety Controls have been applied successfully! Please validate them before pushing to DV360.');
}

function errorHandler(param){
  setStatus('There was an error while applying the Brand Safety Controls.');
}

</script>